<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guitar Neck Template Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background-color: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 32px;
            align-items: flex-start;
        }
        .controls {
            flex: 1;
            min-width: 340px;
            background: #fff;
            padding: 28px 24px 24px 24px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.10);
            margin-bottom: 24px;
        }
        .section {
            border: 1px solid #e0e0e0;
            padding: 10px 10px 8px 10px;
            margin-bottom: 10px;
            border-radius: 7px;
            background: #fafbfc;
        }
        .section-title {
            font-size: 1em;
            font-weight: bold;
            margin-bottom: 8px;
            color: #222;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 3px;
            letter-spacing: 0.2px;
        }
        .output {
            flex: 2;
            min-width: 600px;
            background: #fff;
            padding: 18px 14px 14px 14px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.10);
            margin-bottom: 24px;
        }
        .output h2 {
            font-size: 1.1em;
            color: #222;
            margin-bottom: 8px;
        }
        .parameter {
            margin-bottom: 10px;
        }
        label {
            display: inline-block;
            margin-bottom: 2px;
            font-weight: 500;
            font-size: 0.97em;
            margin-right: 6px;
        }
        input[type="range"] {
            width: 100px;
            margin-bottom: 0;
            vertical-align: middle;
        }
        .value-display {
            display: inline-flex;
            justify-content: space-between;
            font-size: 0.92em;
            color: #666;
            margin-left: 8px;
        }
        select {
            width: 140px;
        }
        input[type="number"] {
            width: 70px;
        }
        select:focus, input[type="number"]:focus {
            border: 1.5px solid #2196F3;
            outline: none;
        }
        button {
            width: 100%;
            padding: 12px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 17px;
            margin-top: 14px;
            transition: background 0.2s;
        }
        button:hover {
            background-color: #1769aa;
        }
        #svg-output {
            width: 100%;
            height: 900px;
            border: 2px solid #e0e0e0;
            margin-bottom: 18px;
            background-color: #f8fafc;
            overflow: hidden;
            position: relative;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
        #svg-output svg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 100%;
            max-height: 100%;
        }
        #svg-code {
            width: 100%;
            height: 220px;
            font-family: monospace;
            padding: 12px;
            border: 1.5px solid #e0e0e0;
            border-radius: 6px;
            overflow: auto;
            white-space: pre;
            box-sizing: border-box;
            background: #f8f8f8;
            font-size: 1em;
        }
        .checkbox-group {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px 18px;
        }
        .checkbox-item {
            margin-bottom: 0;
            display: flex;
            align-items: center;
            font-size: 0.97em;
        }
        .checkbox-item input {
            margin-right: 5px;
        }
        .download-btn {
            margin-top: 14px;
            background-color: #2196F3;
        }
        .download-btn:hover {
            background-color: #1769aa;
        }
        .info-text {
            font-size: 0.93em;
            color: #666;
            margin-top: 6px;
            font-style: italic;
        }
        .row {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .col {
            flex: 1;
            min-width: 0;
        }
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .zoom-btn {
            padding: 6px 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }
        .zoom-btn:hover {
            background-color: #388e3c;
        }
        .zoom-level {
            font-size: 15px;
            color: #666;
        }
        @media (max-width: 900px) {
            .container {
                flex-direction: column;
            }
            .output, .controls {
                min-width: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <h1>Guitar Neck Template Generator</h1>
    
    <div class="container">
        <div class="controls">
            <div class="section">
                <div class="section-title">Basic Settings</div>
                <div class="parameter">
                    <label for="fret-count">Fret Count:</label>
                    <select id="fret-count" class="update-trigger">
                        <option value="22">22 Frets</option>
                        <option value="24">24 Frets</option>
                    </select>
                </div>
                
                <div class="parameter">
                    <label for="scale-length-type">Scale Length:</label>
                    <select id="scale-length-type" class="update-trigger">
                        <option value="25.5">25.5 inches (648.2mm) - Fender Standard</option>
                        <option value="24.75">24.75 inches (628.65mm) - Gibson Standard</option>
                        <option value="custom">Custom Scale Length</option>
                    </select>
                    
                    <div id="custom-scale" style="display: none; margin-top: 10px;">
                        <div class="row">
                            <div class="col">
                                <label for="custom-scale-value">Length:</label>
                                <input type="number" id="custom-scale-value" class="update-trigger" step="0.01" value="25.5">
                            </div>
                            <div class="col">
                                <label for="custom-scale-unit">Unit:</label>
                                <select id="custom-scale-unit" class="update-trigger">
                                    <option value="inches">inches</option>
                                    <option value="mm">mm</option>
                                </select>
                            </div>
                        </div>
                        <div class="info-text">
                            <span id="scale-conversion"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Neck Dimensions</div>
                <div class="parameter">
                    <label for="nut-width">Nut Width (mm):</label>
                    <input type="range" id="nut-width" class="update-trigger" min="40" max="50" step="0.5" value="43">
                    <span id="nut-width-value" style="margin-left:8px; font-size:0.97em; color:#444;">43mm</span>
                </div>

                <div class="parameter">
                    <label for="nut-extension">Nut Extension (mm):</label>
                    <input type="range" id="nut-extension" class="update-trigger" min="0" max="20" step="0.5" value="0">
                    <span id="nut-extension-value" style="margin-left:8px; font-size:0.97em; color:#444;">0mm</span>
                </div>

                <div class="parameter">
                    <label for="heel-position">Heel Position Relative to Last Fret (mm):</label>
                    <input type="range" id="heel-position" class="update-trigger" min="-10" max="100" step="1" value="2">
                    <span id="heel-position-value" style="margin-left:8px; font-size:0.97em; color:#444;">2mm</span>
                    <div class="info-text">Distance from last fret to heel start (negative = overlap)</div>
                </div>
                
                <div class="parameter">
                    <label for="heel-radius">Heel Corner Radius (mm):</label>
                    <input type="range" id="heel-radius" class="update-trigger" min="1" max="10" step="0.5" value="6.35">
                    <span id="heel-radius-value" style="margin-left:8px; font-size:0.97em; color:#444;">6.35mm</span>
                </div>
            </div>

            <div class="section">
                <div class="section-title">String Layout</div>
                <div class="parameter">
                    <label for="string-spacing-type">String Spacing at Bridge (E-to-E):</label>
                    <select id="string-spacing-type" class="update-trigger">
                        <option value="52.5">52.5mm (2.067") - Hardtail Standard</option>
                        <option value="51">51.0mm (2.008") - TOM Standard</option>
                        <option value="custom">Custom Spacing</option>
                    </select>
                    
                    <div id="custom-spacing" style="display: none; margin-top: 10px;">
                        <div class="row">
                            <div class="col">
                                <label for="string-spacing-value">Spacing:</label>
                                <input type="number" id="string-spacing-value" class="update-trigger" step="0.1" value="52.5" min="45" max="65">
                            </div>
                            <div class="col">
                                <label for="string-spacing-unit">Unit:</label>
                                <select id="string-spacing-unit" class="update-trigger">
                                    <option value="mm">mm</option>
                                    <option value="inches">inches</option>
                                </select>
                            </div>
                        </div>
                        <div class="info-text">
                            <span id="spacing-conversion"></span>
                        </div>
                    </div>
                    <div class="info-text">Distance between the outer E strings at the bridge</div>
                </div>
                
                <div class="parameter">
                    <div class="row">
                        <div class="col">
                            <label for="treble-e-margin">Treble E Margin (mm):</label>
                            <input type="range" id="treble-e-margin" class="update-trigger" min="1" max="6" step="0.5" value="3">
                            <span id="treble-e-margin-value" style="margin-left:8px; font-size:0.97em; color:#444;">3mm</span>
                        </div>
                        <div class="col">
                            <label for="bass-e-margin">Bass E Margin (mm):</label>
                            <input type="range" id="bass-e-margin" class="update-trigger" min="1" max="6" step="0.5" value="3.5">
                            <span id="bass-e-margin-value" style="margin-left:8px; font-size:0.97em; color:#444;">3.5mm</span>
                        </div>
                    </div>
                    <div class="info-text">Extra width added beyond the E strings</div>
                </div>
            </div>

            <button id="download-btn" class="download-btn">Download SVG</button>
        </div>
        
        <div class="output">
            <div class="section">
                <div class="section-title">Visual Settings</div>
                <div class="parameter">
                    <label>Line Thickness (mm):</label>
                    <div class="row">
                        <div class="col">
                            <label for="outline-thickness">Outline:</label>
                            <input type="number" id="outline-thickness" class="update-trigger" min="0.01" max="1" step="0.01" value="0.1">
                        </div>
                        <div class="col">
                            <label for="centerline-thickness">Centerline:</label>
                            <input type="number" id="centerline-thickness" class="update-trigger" min="0.01" max="1" step="0.01" value="0.1">
                        </div>
                        <div class="col">
                            <label for="string-thickness">Strings:</label>
                            <input type="number" id="string-thickness" class="update-trigger" min="0.01" max="1" step="0.01" value="0.05">
                        </div>
                    </div>
                </div>

                <div class="parameter">
                    <div class="row">
                        <div class="col">
                            <label for="centerline-color">Centerline Color:</label>
                            <input type="color" id="centerline-color" class="update-trigger" value="#000000">
                        </div>
                        <div class="col">
                            <label for="string-color">String Color:</label>
                            <input type="color" id="string-color" class="update-trigger" value="#000000">
                        </div>
                    </div>
                </div>

                <div class="parameter">
                    <label for="kerf-compensation">Kerf Compensation (mm):</label>
                    <input type="range" id="kerf-compensation" class="update-trigger" min="-0.5" max="0.5" step="0.01" value="0">
                    <span id="kerf-compensation-value" style="margin-left:8px; font-size:0.97em; color:#444;">0mm</span>
                    <div class="info-text">Adjust template size to compensate for laser cutter kerf</div>
                </div>
            </div>
            <div class="section">
                <div class="section-title">Display Options</div>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="show-centerline" class="update-trigger" checked>
                        <label for="show-centerline">Show Centerline</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="show-strings" class="update-trigger" checked>
                        <label for="show-strings">Show Strings</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="show-labels" class="update-trigger" checked>
                        <label for="show-labels">Show Labels</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="show-frets" class="update-trigger" checked>
                        <label for="show-frets">Show Fret Positions</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="show-bridge" class="update-trigger" checked>
                        <label for="show-bridge">Show Bridge</label>
                    </div>
                </div>
            </div>
            <h2>Preview</h2>
            <div id="svg-output"></div>
            <h2>SVG Code</h2>
            <textarea id="svg-code" readonly></textarea>
        </div>
    </div>

    <script>
        // Calculate fret positions based on scale length
        function calculateFretPositions(scaleLength, fretCount) {
            const fretPositions = [];
            for (let i = 1; i <= fretCount; i++) {
                const fretPos = scaleLength - (scaleLength / Math.pow(2, i/12));
                fretPositions.push(fretPos);
            }
            return fretPositions;
        }

        // Handle scale length conversion display
        function updateScaleConversion() {
            const value = parseFloat(document.getElementById('custom-scale-value').value);
            const unit = document.getElementById('custom-scale-unit').value;
            const conversionSpan = document.getElementById('scale-conversion');
            
            if (unit === 'inches') {
                conversionSpan.textContent = `${value} inches = ${(value * 25.4).toFixed(2)}mm`;
            } else {
                conversionSpan.textContent = `${value}mm = ${(value / 25.4).toFixed(3)} inches`;
            }
        }

        // Handle string spacing conversion display
        function updateSpacingConversion() {
            const value = parseFloat(document.getElementById('string-spacing-value').value);
            const unit = document.getElementById('string-spacing-unit').value;
            const conversionSpan = document.getElementById('spacing-conversion');
            
            if (unit === 'mm') {
                conversionSpan.textContent = `${value}mm = ${(value / 25.4).toFixed(3)} inches`;
            } else {
                conversionSpan.textContent = `${value} inches = ${(value * 25.4).toFixed(2)}mm`;
            }
        }

        function generateTemplate() {
            const fretCount = parseInt(document.getElementById('fret-count').value);
            const scaleType = document.getElementById('scale-length-type').value;
            let scaleLength;
            let displayScale;
            
            if (scaleType === 'custom') {
                const scaleValue = parseFloat(document.getElementById('custom-scale-value').value);
                const scaleUnit = document.getElementById('custom-scale-unit').value;
                if (scaleUnit === 'mm') {
                    scaleLength = scaleValue;
                    displayScale = (scaleValue / 25.4).toFixed(3) + '"';
                } else {
                    scaleLength = scaleValue * 25.4; // Convert inches to mm
                    displayScale = scaleValue + '"';
                }
            } else {
                scaleLength = parseFloat(scaleType) * 25.4; // Convert standard scales to mm
                displayScale = scaleType + '"';
            }

            const nutWidth = parseFloat(document.getElementById('nut-width').value);
            
            // Handle string spacing with units
            const spacingType = document.getElementById('string-spacing-type').value;
            let stringSpacing;
            let displaySpacing;
            
            if (spacingType === 'custom') {
                const spacingValue = parseFloat(document.getElementById('string-spacing-value').value);
                const spacingUnit = document.getElementById('string-spacing-unit').value;
                if (spacingUnit === 'mm') {
                    stringSpacing = spacingValue;
                    displaySpacing = `${spacingValue}mm`;
                } else {
                    stringSpacing = spacingValue * 25.4; // Convert inches to mm
                    displaySpacing = `${(stringSpacing).toFixed(1)}mm`;
                }
            } else {
                stringSpacing = parseFloat(spacingType);
                displaySpacing = `${stringSpacing}mm`;
            }

            const bassEMargin = parseFloat(document.getElementById('bass-e-margin').value);
            const trebleEMargin = parseFloat(document.getElementById('treble-e-margin').value);
            const heelPosition = parseFloat(document.getElementById('heel-position').value);
            const heelRadius = parseFloat(document.getElementById('heel-radius').value);
            const kerfCompensation = parseFloat(document.getElementById('kerf-compensation').value);
            const outlineThickness = parseFloat(document.getElementById('outline-thickness').value);
            const centerlineThickness = parseFloat(document.getElementById('centerline-thickness').value);
            const stringThickness = parseFloat(document.getElementById('string-thickness').value);
            const showCenterline = document.getElementById('show-centerline').checked;
            const showStrings = document.getElementById('show-strings').checked;
            const showLabels = document.getElementById('show-labels').checked;
            const showFrets = document.getElementById('show-frets').checked;
            const centerlineColor = document.getElementById('centerline-color').value;
            const stringColor = document.getElementById('string-color').value;
            const showBridge = document.getElementById('show-bridge').checked;
            
            // Move nutExtension up before it is used
            const nutExtension = parseFloat(document.getElementById('nut-extension').value);
            // Calculate bridge width (E-to-E + margins)
            const bridgeWidth = stringSpacing + bassEMargin + trebleEMargin;
            const padding = 50;
            const svgWidth = Math.max(nutWidth, bridgeWidth) + (padding * 2);
            const svgHeight = scaleLength + (padding * 2) + nutExtension;
            const centerX = svgWidth / 2;
            
            // Outline positions (with kerf compensation)
            const nutWidthComp = nutWidth + kerfCompensation * 2;
            const bridgeWidthComp = bridgeWidth + kerfCompensation * 2;
            const nutLeft = centerX - nutWidthComp / 2;
            const nutRight = centerX + nutWidthComp / 2;
            const bridgeLeft = centerX - bridgeWidthComp / 2;
            const bridgeRight = centerX + bridgeWidthComp / 2;
            // String positions (NO kerf compensation)
            const nutLeftStr = centerX - nutWidth / 2;
            const nutRightStr = centerX + nutWidth / 2;
            const bridgeLeftStr = centerX - bridgeWidth / 2;
            const bridgeRightStr = centerX + bridgeWidth / 2;
            const nutStringStart = nutLeftStr + bassEMargin;
            const nutStringEnd = nutRightStr - trebleEMargin;
            const nutStringSpacing = (nutStringEnd - nutStringStart) / 5;
            const nutStringX = Array.from({length: 6}, (_, i) => nutStringStart + i * nutStringSpacing);
            const bridgeStringStart = bridgeLeftStr + bassEMargin;
            const bridgeStringEnd = bridgeRightStr - trebleEMargin;
            const bridgeStringSpacing = (bridgeStringEnd - bridgeStringStart) / 5;
            const bridgeStringX = Array.from({length: 6}, (_, i) => bridgeStringStart + i * bridgeStringSpacing);
            // Helper to interpolate between nut and bridge (for outline and for strings)
            function interp(a, b, t) { return a + (b - a) * t; }
            
            // Calculate neck length based on scale length and fret count
            const fretPositions = calculateFretPositions(scaleLength, fretCount);
            const lastFretPosition = fretPositions[fretPositions.length - 1];
            
            // Setup coordinate system
            const nutY = padding + nutExtension;
            const bridgeY = nutY + scaleLength;
            
            // Calculate heel position
            // heelEndY is where the heel ends (last fret + heel position)
            const heelEndY = nutY + lastFretPosition + heelPosition;
            // Heel depth (fixed, e.g., 20mm)
            const heelDepth = 20;
            const heelStartY = heelEndY - heelDepth;
            // Interpolate left/right at heelStartY and heelEndY (outline, with kerf)
            const tHeelStart = (heelStartY - nutY) / (bridgeY - nutY);
            const tHeelEnd = (heelEndY - nutY) / (bridgeY - nutY);
            const heelLeftStart = interp(nutLeft, bridgeLeft, tHeelStart);
            const heelRightStart = interp(nutRight, bridgeRight, tHeelStart);
            const heelLeftEnd = interp(nutLeft, bridgeLeft, tHeelEnd);
            const heelRightEnd = interp(nutRight, bridgeRight, tHeelEnd);
            
            // Start building SVG
            let svgContent = `<svg width="${svgWidth}mm" height="${svgHeight}mm" viewBox="0 0 ${svgWidth} ${svgHeight}" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
                <style>
                    .measurement { font-size: 12px; }
                    .title { font-size: 14px; }
                </style>`;
            
            // Create a single continuous path for nut extension, nut, neck, and heel (no bridge, nut extension included)
            let outlinePath = '';
            // Start at top left of nut extension if present, else nutLeft, nutY
            if (nutExtension > 0) {
                outlinePath += `M${nutLeft},${nutY - nutExtension} `;
            } else {
                outlinePath += `M${nutLeft},${nutY} `;
            }
            // Down left side: nut extension (if any), nut, neck, directly to heel
            if (nutExtension > 0) {
                outlinePath += `L${nutLeft},${nutY} `;
            }
            outlinePath += `L${heelLeftEnd},${heelEndY - heelRadius} `;
            outlinePath += `Q${heelLeftEnd},${heelEndY} ${heelLeftEnd + heelRadius},${heelEndY} `;
            outlinePath += `L${heelRightEnd - heelRadius},${heelEndY} `;
            outlinePath += `Q${heelRightEnd},${heelEndY} ${heelRightEnd},${heelEndY - heelRadius} `;
            // Up right side: directly to nut extension (if any)
            outlinePath += `L${nutRight},${nutY} `;
            if (nutExtension > 0) {
                outlinePath += `L${nutRight},${nutY - nutExtension} `;
                outlinePath += `L${nutLeft},${nutY - nutExtension} `;
            } else {
                outlinePath += `L${nutLeft},${nutY} `;
            }
            outlinePath += 'Z';
            svgContent += `\n<path d="${outlinePath}"
                fill="none" stroke="black" stroke-width="${outlineThickness}"/>`;
            // Draw the nut as a zero fret line (compensated)
            svgContent += `\n<line x1="${nutLeft}" y1="${nutY}" x2="${nutRight}" y2="${nutY}" stroke="black" stroke-width="${outlineThickness}"/>`;
            
            // Add fret positions if requested
            if (showFrets) {
                fretPositions.forEach((pos, idx) => {
                    const fretY = nutY + pos;
                    const t = (fretY - nutY) / (bridgeY - nutY);
                    const left = interp(nutLeft, bridgeLeft, t);
                    const right = interp(nutRight, bridgeRight, t);
                    svgContent += `
                    <line x1="${left}" y1="${fretY}" x2="${right}" y2="${fretY}" 
                          stroke="#666" stroke-width="${outlineThickness}"/>`;
                    // Add fret markers at traditional positions
                    const markerRadius = 2;
                    const markerPositions = [2, 4, 6, 8, 11, 14, 16, 18, 20, 23];
                    if (markerPositions.includes(idx)) {
                        if (idx === 11 || idx === 23) { // Double dot for 12th and 24th fret
                            svgContent += `
                            <circle cx="${centerX - 10}" cy="${fretY - ((fretY - (idx === 0 ? nutY : nutY + fretPositions[idx - 1])) / 2)}" r="${markerRadius}" fill="#ccc"/>
                            <circle cx="${centerX + 10}" cy="${fretY - ((fretY - (idx === 0 ? nutY : nutY + fretPositions[idx - 1])) / 2)}" r="${markerRadius}" fill="#ccc"/>`;
                        } else {
                            svgContent += `
                            <circle cx="${centerX}" cy="${fretY - ((fretY - (idx === 0 ? nutY : nutY + fretPositions[idx - 1])) / 2)}" r="${markerRadius}" fill="#ccc"/>`;
                        }
                    }
                });
            }
            
            // Add centerline if requested
            if (showCenterline) {
                if (nutExtension > 0) {
                    svgContent += `
                    <line x1="${centerX}" y1="${padding}" x2="${centerX}" y2="${nutY}" 
                          stroke="${centerlineColor}" stroke-width="${centerlineThickness}" />`;
                }
                const centerlineEndY = showBridge ? bridgeY : heelEndY;
                svgContent += `
                <line x1="${centerX}" y1="${nutY}" x2="${centerX}" y2="${centerlineEndY}" 
                      stroke="${centerlineColor}" stroke-width="${centerlineThickness}" />`;
            }
            
            // Draw strings if requested
            if (showStrings) {
                const yEnd = showBridge ? bridgeY : heelEndY;
                const stringXEnd = showBridge ? bridgeStringX : bridgeStringX.map((x, i) => interp(nutStringX[i], bridgeStringX[i], (heelEndY - nutY) / (bridgeY - nutY)));
                for (let i = 0; i < 6; i++) {
                    // Draw extension before nut (parallel)
                    if (nutExtension > 0) {
                        svgContent += `
                        <line x1="${nutStringX[i]}" y1="${nutY - nutExtension}" x2="${nutStringX[i]}" y2="${nutY}" 
                              stroke="${stringColor}" stroke-width="${stringThickness}"/>`;
                    }
                    svgContent += `
                    <line x1="${nutStringX[i]}" y1="${nutY}" x2="${stringXEnd[i]}" y2="${yEnd}" 
                          stroke="${stringColor}" stroke-width="${stringThickness}"/>`;
                }
                // Add bridge string spacing indicator ONLY if bridge is shown
                if (showBridge) {
                    // Place the indicator slightly above the bridge for clarity
                    const y = bridgeY - 8;
                    const x1 = bridgeStringX[0]; // E string
                    const x2 = bridgeStringX[1]; // A string
                    const actualSpacing = Math.abs(x2 - x1);
                    // Draw a smaller, more accurate double-headed arrow and marker ONLY if bridge is shown
                    svgContent += `
                    <svg width="0" height="0">
                        <defs>
                            <marker id="arrow-small" markerWidth="4" markerHeight="4" refX="2" refY="2" orient="auto" markerUnits="strokeWidth">
                                <path d="M0,0 L4,2 L0,4 L1.3,2 Z" fill="#2196F3" />
                            </marker>
                        </defs>
                    </svg>
                    <g>
                        <line x1="${x1}" y1="${y}" x2="${x2}" y2="${y}" stroke="#2196F3" stroke-width="0.8" marker-start="url(#arrow-small)" marker-end="url(#arrow-small)"/>
                        <text x="${(x1 + x2) / 2}" y="${y - 3}" font-family="Arial" font-size="9" text-anchor="middle" fill="#2196F3">${actualSpacing.toFixed(2)}mm</text>
                    </g>
                    `;
                }
            }
            
            // Add labels if requested
            if (showLabels) {
                // Add scale length
                svgContent += `
                <text x="${centerX + nutWidth / 2 + 10}" y="${(nutY + bridgeY) / 2}" font-family="Arial" font-size="8" text-anchor="start">
                    ${displayScale}</text>`;
                
                // Add nut width
                svgContent += `
                <text x="${centerX}" y="${nutY - 5}" font-family="Arial" font-size="8" text-anchor="middle">
                    ${nutWidth}mm</text>`;
                
                // Add string spacing at bridge
                if(showBridge) {
                    svgContent += `
                    <text x="${centerX}" y="${bridgeY + 15}" font-family="Arial" font-size="8" text-anchor="middle">
                        ${displaySpacing} E-E</text>`;
                    }
            }
            
            // Close SVG
            svgContent += `</svg>`;
            
            // Display SVG
            document.getElementById('svg-output').innerHTML = svgContent;
            document.getElementById('svg-code').value = svgContent;
            
            return svgContent;
        }

        // Handle scale length type changes
        document.getElementById('scale-length-type').addEventListener('change', function(e) {
            const customScaleDiv = document.getElementById('custom-scale');
            const customScaleValue = document.getElementById('custom-scale-value');
            const customScaleUnit = document.getElementById('custom-scale-unit');
            
            if (e.target.value === 'custom') {
                customScaleDiv.style.display = 'block';
            } else {
                customScaleDiv.style.display = 'none';
                customScaleValue.value = e.target.value;
                customScaleUnit.value = 'inches';
            }
            updateScaleConversion();
            generateTemplate();
        });

        // Handle string spacing type changes
        document.getElementById('string-spacing-type').addEventListener('change', function(e) {
            const customSpacingDiv = document.getElementById('custom-spacing');
            const customSpacingValue = document.getElementById('string-spacing-value');
            const customSpacingUnit = document.getElementById('string-spacing-unit');
            
            if (e.target.value === 'custom') {
                customSpacingDiv.style.display = 'block';
            } else {
                customSpacingDiv.style.display = 'none';
                customSpacingValue.value = e.target.value;
                customSpacingUnit.value = 'mm';
            }
            updateSpacingConversion();
            generateTemplate();
        });

        // Add event listeners for all sliders
        document.getElementById('nut-width').addEventListener('input', (e) => {
            document.getElementById('nut-width-value').textContent = e.target.value + 'mm';
        });
        document.getElementById('bass-e-margin').addEventListener('input', (e) => {
            document.getElementById('bass-e-margin-value').textContent = e.target.value + 'mm';
        });
        document.getElementById('treble-e-margin').addEventListener('input', (e) => {
            document.getElementById('treble-e-margin-value').textContent = e.target.value + 'mm';
        });
        document.getElementById('heel-position').addEventListener('input', (e) => {
            document.getElementById('heel-position-value').textContent = e.target.value + 'mm';
        });
        document.getElementById('heel-radius').addEventListener('input', (e) => {
            document.getElementById('heel-radius-value').textContent = e.target.value + 'mm';
        });
        document.getElementById('kerf-compensation').addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            const prefix = value >= 0 ? '+' : '';
            document.getElementById('kerf-compensation-value').textContent = prefix + value + 'mm';
        });
        document.getElementById('nut-extension').addEventListener('input', (e) => {
            document.getElementById('nut-extension-value').textContent = e.target.value + 'mm';
        });

        // Add event listeners for custom scale inputs
        document.getElementById('custom-scale-value').addEventListener('input', updateScaleConversion);
        document.getElementById('custom-scale-unit').addEventListener('change', updateScaleConversion);

        // Add event listeners for custom spacing inputs
        document.getElementById('string-spacing-value').addEventListener('input', updateSpacingConversion);
        document.getElementById('string-spacing-unit').addEventListener('change', updateSpacingConversion);

        // Add event listeners to all form controls
        document.querySelectorAll('.update-trigger').forEach(element => {
            element.addEventListener('input', generateTemplate);
            element.addEventListener('change', generateTemplate);
        });
        
        // Download SVG file
        document.getElementById('download-btn').addEventListener('click', () => {
            const svgContent = document.getElementById('svg-code').value;
            const blob = new Blob([svgContent], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            // Generate filename based on parameters 
            const fretCount = document.getElementById('fret-count').value;
            const scaleType = document.getElementById('scale-length-type').value;
            let scaleText;
            
            if (scaleType === 'custom') {
                const scaleValue = document.getElementById('custom-scale-value').value;
                const scaleUnit = document.getElementById('custom-scale-unit').value;
                scaleText = scaleUnit === 'mm' ? `${scaleValue}mm` : `${scaleValue}in`;
            } else {
                scaleText = `${scaleType}in`;
            }
            
            const stringSpacing = document.getElementById('string-spacing-value').value;
            const heelPosition = document.getElementById('heel-position').value;
            const kerfCompensation = document.getElementById('kerf-compensation').value;
            
            let filename = `neck-${fretCount}fret-${scaleText}-${stringSpacing}mm-heel${heelPosition}mm`;
            if (parseFloat(kerfCompensation) !== 0) {
                filename += `-kerf${kerfCompensation}`;
            }
            filename += '.svg';
            
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        
        // Generate initial template
        window.addEventListener('load', generateTemplate);
    </script>
</body>
</html>
